{% extends 'sorting/base.html' %}

{% block title %}Wprowadź Wagę - Krok 3 - Sortownia Odzieży{% endblock %}

{% block header %}Dodaj Worek - Krok 3{% endblock %}

{% block extra_css %}
<style>
/* Mobile-specific optimizations for step 3 */
@media (max-width: 768px) {
    .form-section {
        padding-bottom: 100px; /* Extra space for mobile keyboard */
    }
    
    .weight-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 15px;
    }
    
    .weight-buttons .btn {
        padding: 12px;
        font-size: 16px;
        min-height: 50px;
    }
    
    .wizard-buttons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 15px;
        border-top: 1px solid #dee2e6;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    .wizard-buttons .btn {
        min-height: 50px;
        font-size: 16px;
    }
    
    /* Ensure input is large enough to prevent zoom on iOS */
    input[name="weight_kg"] {
        font-size: 16px !important;
        padding: 12px !important;
        min-height: 50px;
    }
    
    /* Style weight input when focused */
    input[name="weight_kg"]:focus {
        transform: scale(1.05);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        border-color: #007bff;
    }
}

/* Desktop enhancements */
@media (min-width: 769px) {
    .weight-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}


{% block content %}
<div class="container-fluid py-4">
    <!-- Step Indicator -->
    <div class="steps-indicator mb-4">
        <div class="step step-1 completed">
            <div class="step-circle">1</div>
            <div class="step-label">Gniazdo</div>
        </div>
        <div class="step step-2 completed">
            <div class="step-circle">2</div>
            <div class="step-label">Typ Worka</div>
        </div>
        <div class="step step-3 active">
            <div class="step-circle">3</div>
            <div class="step-label">Waga</div>
        </div>
        <div class="step step-4">
            <div class="step-circle"><i class="fas fa-check"></i></div>
            <div class="step-label">Podsumowanie</div>
        </div>
    </div>

    <!-- Step 3: Weight Section -->
    <div class="form-section">
        <h2 class="form-section-title">
            <i class="fas fa-weight me-2"></i> Wprowadź Wagę
        </h2>
        
        <!-- Breadcrumb info -->
        <div class="breadcrumb-info">
            <small class="text-muted">Wybrane Gniazdo:</small>
            <strong class="text-primary">{{ socket_info }}</strong>
            <br><small class="text-muted">Wybrany Typ Worka:</small>
            <strong class="text-primary">{{ bag_type_name }}</strong>
        </div>
        
        <form method="post" id="weightWizardForm">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="{{ form.weight_kg.id_for_label }}" class="form-label">{{ form.weight_kg.label }}</label>
                <div class="mb-2">
                    {{ form.weight_kg }}
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="resetWeightBtn">Resetuj</button>
                </div>
                <div class="form-text mb-2">Użyj przycisków poniżej, aby szybko ustawić wagę:</div>
                <div class="weight-buttons">
                    <button type="button" class="btn btn-outline-success weight-adjust" data-amount="0.1">+0.1</button>
                    <button type="button" class="btn btn-outline-success weight-adjust" data-amount="0.5">+0.5</button>
                    <button type="button" class="btn btn-outline-success weight-adjust" data-amount="1">+1</button>
                    <button type="button" class="btn btn-outline-success weight-adjust" data-amount="5">+5</button>
                    <button type="button" class="btn btn-outline-success weight-adjust" data-amount="10">+10</button>
                </div>
                {% if form.weight_kg.errors %}
                <div class="alert alert-danger mt-2">
                    {{ form.weight_kg.errors }}
                </div>
                {% endif %}
            </div>

            <div class="mb-4">
                <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                <div class="alert alert-danger mt-2">
                    {{ form.notes.errors }}
                </div>
                {% endif %}
            </div>

            <div class="wizard-buttons">
                <a href="{% url 'sorting:step2_bagtype_selection' %}" class="btn btn-outline-secondary btn-prev btn-tablet">
                    <i class="fas fa-arrow-left me-1"></i> Wstecz
                </a>
                <button type="submit" class="btn btn-primary btn-tablet" id="step3Next">
                    Dalej <i class="fas fa-arrow-right ms-1"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Weight Input Fix for Mobile Devices -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const weightInput = document.querySelector('input[name="weight_kg"]');
    const weightButtons = document.querySelectorAll('.weight-adjust');
    const resetBtn = document.getElementById('resetWeightBtn');
    
    // Mobile detection
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
               || window.innerWidth <= 768
               || 'ontouchstart' in window;
    }
    
    // Mobile-specific behavior
    if (isMobileDevice()) {
        console.log('Mobile device detected, applying mobile optimizations...');
        
        // Scroll to weight input area and focus after a brief delay
        setTimeout(function() {
            // Calculate better scroll position to account for mobile keyboard
            const viewportHeight = window.innerHeight;
            const inputRect = weightInput.getBoundingClientRect();
            const scrollTarget = window.pageYOffset + inputRect.top - (viewportHeight * 0.3);
            
            // Smooth scroll to calculated position
            window.scrollTo({
                top: scrollTarget,
                behavior: 'smooth'
            });
            
            // Focus on input after scroll completes
            setTimeout(function() {
                weightInput.focus();
                
                // Additional trigger for iOS
                setTimeout(function() {
                    weightInput.click();
                    weightInput.dispatchEvent(new Event('touchstart', { bubbles: true }));
                }, 100);
            }, 600);
        }, 300);
        
        // Handle virtual keyboard appearance/disappearance on mobile
        let initialViewportHeight = window.innerHeight;
        
        window.addEventListener('resize', function() {
            const currentHeight = window.innerHeight;
            const heightDifference = initialViewportHeight - currentHeight;
            
            // If height decreased significantly, keyboard is likely open
            if (heightDifference > 150) {
                console.log('Virtual keyboard detected, adjusting layout...');
                document.body.style.paddingBottom = '0px';
                
                // Ensure input stays visible
                setTimeout(function() {
                    if (weightInput === document.activeElement) {
                        weightInput.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                }, 100);
            } else if (heightDifference < 50) {
                // Keyboard likely closed
                console.log('Virtual keyboard closed, restoring layout...');
                document.body.style.paddingBottom = '';
            }
        });
        
        // Make input field larger on mobile
        weightInput.style.fontSize = '18px';
        weightInput.style.padding = '12px';
        weightInput.style.minHeight = '50px';
        
        // Ensure proper mobile keyboard
        weightInput.setAttribute('inputmode', 'decimal');
        weightInput.setAttribute('pattern', '[0-9]*\\.?[0-9]*');
        
        // Additional mobile keyboard triggers
        weightInput.addEventListener('touchstart', function() {
            this.focus();
        });
        
        // Prevent zoom on iOS
        weightInput.addEventListener('focus', function() {
            if (this.style.fontSize !== '16px') {
                this.style.fontSize = '16px';
            }
        });
    }
    
    // Focus on weight input for all devices
    if (weightInput) {
        // Convert NumberInput to text with numeric characteristics for better mobile support
        if (weightInput.type === 'number') {
            weightInput.type = 'text';
            weightInput.inputMode = 'decimal';
            weightInput.pattern = '[0-9]*\\.?[0-9]*';
        }
        
        // Initial focus (delayed for non-mobile to avoid issues)
        if (!isMobileDevice()) {
            setTimeout(function() {
                weightInput.focus();
                weightInput.select();
            }, 100);
        }
    }
    
    // Weight adjustment buttons
    weightButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const amount = parseFloat(this.getAttribute('data-amount'));
            const currentValue = parseFloat(weightInput.value) || 0;
            const newValue = (currentValue + amount).toFixed(2);
            weightInput.value = newValue;
            weightInput.focus();
        });
    });
    
    // Reset button
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            weightInput.value = '';
            weightInput.focus();
        });
    }
    
    // Auto-submit on Enter key
    if (weightInput) {
        weightInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('step3Next').click();
            }
        });
        
        // Input validation for mobile
        weightInput.addEventListener('input', function(e) {
            // Keep only digits and decimal point
            let value = this.value.replace(/[^0-9.]/g, '');
            
            // Ensure only one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }

            // Update input value only if it changed to avoid cursor jumping
            if (this.value !== value) {
                this.value = value;
            }
        });

        // Validate on blur to ensure it's a valid number
        weightInput.addEventListener('blur', function() {
            let value = parseFloat(this.value);

            // If empty or not a number, clear it
            if (isNaN(value) || value <= 0) {
                this.classList.remove('is-valid');
                if (this.value !== '') {
                    this.classList.add('is-invalid');
                }
            } else {
                // Format to 2 decimal places
                this.value = value.toFixed(2);
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });

        // Ensure numeric keyboard on mobile
        weightInput.addEventListener('focus', function() {
            this.inputMode = 'decimal';
        });
    }
    
    // Validate weight input for submit button
    if (weightInput) {
        weightInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            const submitBtn = document.getElementById('step3Next');
            
            if (isNaN(value) || value <= 0) {
                submitBtn.disabled = true;
                this.classList.add('is-invalid');
            } else {
                submitBtn.disabled = false;
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    }
});
</script>
{% endblock %}