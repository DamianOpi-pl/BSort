{% extends 'sorting/base.html' %}

{% block title %}Wybierz Podtyp - Krok 2b - Sortownia Odzieży{% endblock %}

{% block header %}Dodaj Worek - Krok 2b{% endblock %}


{% block content %}
<div class="container-fluid py-4">
    <!-- Step Indicator -->
    <div class="steps-indicator mb-4">
        <div class="step step-1 completed">
            <div class="step-circle">1</div>
            <div class="step-label">Gniazdo</div>
        </div>
        <div class="step step-2 active">
            <div class="step-circle">2</div>
            <div class="step-label">Typ Worka</div>
        </div>
        <div class="step step-3">
            <div class="step-circle">3</div>
            <div class="step-label">Waga</div>
        </div>
        <div class="step step-4">
            <div class="step-circle"><i class="fas fa-check"></i></div>
            <div class="step-label">Podsumowanie</div>
        </div>
    </div>

    <!-- Step 2b: Subtype Selection -->
    <div class="form-section">
        <h2 class="form-section-title">
            <i class="fas fa-layer-group me-2"></i> Wybierz Podtyp
        </h2>
        
        <!-- Breadcrumb info -->
        <div class="breadcrumb-info">
            <small class="text-muted">Wybrane Gniazdo:</small>
            <strong class="text-primary">{{ socket_info }}</strong>
            <br><small class="text-muted">Wybrany Typ Worka:</small>
            <strong class="text-primary">{{ bag_type_name }}</strong>
        </div>
        
        <form method="post" id="subtypeWizardForm">
            {% csrf_token %}
            
            <div class="category-grid">
                {% for subtype in form.bag_subtype.field.queryset %}
                <div class="category-card" style="background-color: {{ subtype.color }};" onclick="selectSubtype({{ subtype.id }});">
                    <input type="radio" name="bag_subtype"
                           value="{{ subtype.id }}"
                           id="id_bag_subtype_{{ subtype.id }}"
                           class="category-radio"
                           {% if form.bag_subtype.value == subtype.id %}checked{% endif %}>
                    <div class="card-body" style="padding: 15px; width: 100%; height: 100%;">
                        <i class="fas fa-layer-group" style="font-size: 2rem; margin-bottom: 8px;"></i>
                        <div class="category-name">{{ subtype.name }}</div>
                        <div class="category-details">
                            {% if subtype.code %}{{ subtype.code }}{% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>Nie znaleziono podtypów!</p>
                {% endfor %}
            </div>

            {% if form.bag_subtype.errors %}
            <div class="alert alert-danger mt-3">
                {{ form.bag_subtype.errors }}
            </div>
            {% endif %}

            <div class="wizard-buttons">
                <a href="{% url 'sorting:step2_bagtype_selection' %}" class="btn btn-outline-secondary btn-prev btn-tablet">
                    <i class="fas fa-arrow-left me-1"></i> Wstecz
                </a>
                <div></div> <!-- Empty div for spacing -->
            </div>
        </form>
    </div>
</div>

<script>
function selectSubtype(subtypeId) {
    // Remove selected class from all cards
    const categoryCards = document.querySelectorAll('.category-card');
    categoryCards.forEach(function(card) {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    const selectedCard = document.querySelector(`input[value="${subtypeId}"]`).closest('.category-card');
    selectedCard.classList.add('selected');
    
    // Check the corresponding radio button
    const radioButton = document.getElementById(`id_bag_subtype_${subtypeId}`);
    if (radioButton) {
        radioButton.checked = true;
    }
    
    // Auto-submit after short delay for visual feedback
    setTimeout(function() {
        document.getElementById('subtypeWizardForm').submit();
    }, 200);
}

document.addEventListener('DOMContentLoaded', function() {
    // Pre-select any checked radio button
    const checkedRadio = document.querySelector('input[type="radio"]:checked');
    if (checkedRadio) {
        const parentCard = checkedRadio.closest('.category-card');
        if (parentCard) {
            parentCard.classList.add('selected');
        }
    }
});
</script>
{% endblock %}